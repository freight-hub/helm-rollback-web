version: 2.1
orbs:
  gcp-gcr: circleci/gcp-gcr@0.13
  helm3-deploy: freighthub/helm3-deploy@dev:fde766f
executors:
  cimg:
    docker:
      - image: cimg/base:2021.03

references:
  main_branch: &main_branch
    branches:
      only:
        - main
  feature_branches: &feature_branches
    branches:
      ignore:
        - main

workflows:
  build-deploy:
    jobs:

      - gcp-gcr/build-and-push-image:
          executor: cimg
          context: gcloud-registry
          dockerfile: build/package/Dockerfile
          image: ${CIRCLE_PROJECT_REPONAME}
          no_output_timeout: 20m
          tag: ${CIRCLE_SHA1}
          remote-docker-version: 19.03.14 #https://discuss.circleci.com/t/docker-build-fails-with-nonsensical-eperm-operation-not-permitted-copyfile/37364
          setup-remote-docker: true
          use-docker-layer-caching: true

      - helm3-deploy/main-deploy:
          name: Deploy Sandbox From PR
          chart_path: deployments/helm/helm-rollback-web
          values_base: sandbox
          release_name: $CIRCLE_PROJECT_REPONAME
          cluster_name: $PLAYGROUND
          namespace: sre-tooling
          context: gcloud-sandbox
          requires:
            - gcp-gcr/build-and-push-image
          filters: *feature_branches

      - helm3-deploy/main-deploy:
          name: Deploy Production from main branch
          chart_path: deployments/helm/helm-rollback-web
          values_base: production
          release_name: $CIRCLE_PROJECT_REPONAME
          cluster_name: $GCLOUD_CLUSTER_NAME
          namespace: sre-tooling
          context: gcloud-production
          requires:
            - gcp-gcr/build-and-push-image
          filters: *main_branch
