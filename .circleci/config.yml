jobs:
  build-and-push:
    executor: gcp-gcr/default
    steps:
      - checkout
      - gcp-gcr/gcr-auth
      - gcp-gcr/build-image:
          dockerfile: build/package/Dockerfile
          image: ${CIRCLE_PROJECT_REPONAME}
          no_output_timeout: 20m
          tag: ${CIRCLE_SHA1}
      - gcp-gcr/push-image:
          digest-path: /tmp/digest.txt
          image: ${CIRCLE_PROJECT_REPONAME}
          tag: ${CIRCLE_SHA1}
      - run:
          command: |
            echo "Digest is: $(</tmp/digest.txt)"
  deploy:
    description: Deploy using helm
    executor: default
    parameters:
      namespace:
        type: string
      cluster_name:
        type: string
      project_name:
        default: "{{cookiecutter.repo_name}}"
        type: string
      values_base:
        default: "test"
        type: string
    steps:
      - checkout
      # - restore_cache: *restore_cache
      - helm3-deploy/deploy_with_helm:
          path_to_helm_chart: deploy/{{cookiecutter.repo_name}}
          update_release_name: << parameters.project_name >>
          sops_aws_access_key_id: $SOPS_AWS_ACCESS_KEY_ID
          sops_aws_secret_access_key: $SOPS_AWS_SECRET_ACCESS_KEY
          cluster: << parameters.cluster_name >>
          namespace: << parameters.namespace >>
          tag: $CIRCLE_SHA1
          values_files: "values.<< parameters.values_base >>.yaml,secrets.<< parameters.values_base >>.yaml"
orbs:
  gcp-gcr: circleci/gcp-gcr@0.13.0
version: 2.1
workflows:
  commit:
    jobs:
      - build-and-push:
          context: gcloud-registry
      - deploy:
          name: deploy-sandbox-master
          values_base: sandbox
          project_name: $CIRCLE_PROJECT_REPONAME
          cluster_name: $PLAYGROUND
          namespace: sre-tooling
          context: gcloud-sandbox
          requires:
            - build-and-push
          # filters:
            # branches:
              # only:
                # - master
